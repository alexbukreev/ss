import{P as q}from"./pdf-lib-F-JeKLTy.js";import{C as F,P as H,D as I}from"./index-Bix4k2Dh.js";import"./vendor-react-43aI2jku.js";import"./vendor-ui-Dlm9CAfc.js";async function z(r){return new Promise((n,o)=>{const t=new Image;t.onload=()=>n(t),t.onerror=a=>o(a),t.src=r})}async function O(r,n,o={}){const t=o.size??F,a=o.bg??"transparent",p=o.captionBg??"rgba(255,255,255,0.82)",u=o.textColor??"#111",s=o.format??"jpeg",i=o.quality??H,d=o.transform??I,c=document.createElement("canvas");c.width=t,c.height=t;const e=c.getContext("2d");if(!e)throw new Error("No 2D context");a!=="transparent"&&(e.fillStyle=a,e.fillRect(0,0,t,t));const m=await z(r.url),l=t/m.width,g=t/m.height,y=Math.min(l,g)*d.scale,P=Math.round(m.width*y),M=Math.round(m.height*y),R=Math.round((t-P)/2+d.tx/100*t),C=Math.round((t-M)/2+d.ty/100*t);e.imageSmoothingQuality="high",e.drawImage(m,R,C,P,M);const B=.06,v=.34,x=Math.max(72,Math.round(t*B)),b=Math.round(x*.22),E=Math.round(x*v),A=Math.round(E*1.25);if(n&&n.trim()){e.font=`${E}px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial`,e.fillStyle=u,e.textBaseline="top";const w=t-b*2;if(n.includes(`
`)||e.measureText(n).width>w){const f=N(e,n,w),h=Math.max(A,f.length*A),_=Math.max(x,b+h+b);e.fillStyle=p,e.fillRect(0,t-_,t,_),e.fillStyle=u;let D=t-_+b;for(const L of f)e.fillText(L,b,D,w),D+=A}else{const f=x;e.fillStyle=p,e.fillRect(0,t-f,t,f);let h=n;if(e.measureText(h).width>w){for(;h.length&&e.measureText(h+"…").width>w;)h=h.slice(0,-1);h+="…"}e.fillStyle=u,e.textBaseline="middle",e.fillText(h,b,t-f/2)}}const S=s==="png"?"image/png":"image/jpeg",j=await new Promise((w,U)=>c.toBlob(f=>f?w(f):U(new Error("toBlob failed")),S,S==="image/jpeg"?i:void 0));return{bytes:new Uint8Array(await j.arrayBuffer()),mime:S,width:t,height:t}}function k(r,n="story-squares.pdf"){const o=new Blob([r],{type:"application/pdf"}),t=document.createElement("a"),a=URL.createObjectURL(o);t.href=a,t.download=n,document.body.appendChild(t),t.click(),t.remove(),URL.revokeObjectURL(a)}function N(r,n,o){const t=n.replace(/\r\n?/g,`
`).split(`
`),a=[];for(const p of t){const u=p.split(/\s+/);let s="";for(const i of u){const d=s?s+" "+i:i;if(r.measureText(d).width<=o)s=d;else if(s&&a.push(s),r.measureText(i).width>o){let c="";for(const e of i){const m=c+e;r.measureText(m).width<=o?c=m:(a.push(c),c=e)}s=c}else s=i}a.push(s)}return a}async function X(r,n,o,t={}){const a=t.size??F,p=t.format??"jpeg",u=t.quality??H,s=t.onProgress,i=await q.create(),d=r.length,c=performance.now(),e=l=>{if(!s)return;const g=performance.now()-c,T=Math.round(l/d*100),y=l>0?g/l*(d-l):void 0;s({done:l,total:d,elapsedMs:g,etaMs:y,pct:T})};e(0);for(let l=0;l<d;l++){const g=r[l],T=(n[g.id]??"").trim(),y=o[g.id]??I,{bytes:P,mime:M,width:R,height:C}=await O(g,T,{size:a,format:p,quality:u,transform:y,bg:t.bg,captionBg:t.captionBg,textColor:t.textColor}),B=M==="image/png"?await i.embedPng(P):await i.embedJpg(P);i.addPage([R,C]).drawImage(B,{x:0,y:0,width:R,height:C}),e(l+1),await new Promise(x=>setTimeout(x,0))}const m=await i.save();k(m)}export{X as exportCardsToPdf};
