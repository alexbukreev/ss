import{P as q}from"./pdf-lib-F-JeKLTy.js";import{C as F,P as H,D as I,d as z}from"./index-B6QWLE2F.js";import"./vendor-react-CbJ0mb0J.js";import"./vendor-ui-BEmGJf5A.js";async function O(r){return new Promise((a,o)=>{const t=new Image;t.onload=()=>a(t),t.onerror=s=>o(s),t.src=r})}async function k(r,a,o={}){const t=o.size??F,s=o.bg??"transparent",y=o.captionBg??"rgba(255,255,255,0.82)",u=o.textColor??"#111",i=o.format??"jpeg",m=o.quality??H,l=o.transform??I,n=document.createElement("canvas");n.width=t,n.height=t;const e=n.getContext("2d");if(!e)throw new Error("No 2D context");s!=="transparent"&&(e.fillStyle=s,e.fillRect(0,0,t,t));const d=await O(r.url),A=t/d.width,c=t/d.height,x=Math.min(A,c)*l.scale,b=Math.round(d.width*x),T=Math.round(d.height*x),M=Math.round((t-b)/2+l.tx/100*t),S=Math.round((t-T)/2+l.ty/100*t);e.imageSmoothingQuality="high",e.drawImage(d,M,S,b,T);const R=.06,C=.34,P=Math.max(72,Math.round(t*R)),w=Math.round(P*.22),B=Math.round(P*C),_=Math.round(B*1.25);if(a&&a.trim()){e.font=`${B}px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial`,e.fillStyle=u,e.textBaseline="top";const p=t-w*2;if(a.includes(`
`)||e.measureText(a).width>p){const f=J(e,a,p),h=Math.max(_,f.length*_),E=Math.max(P,w+h+w);e.fillStyle=y,e.fillRect(0,t-E,t,E),e.fillStyle=u;let D=t-E+w;for(const j of f)e.fillText(j,w,D,p),D+=_}else{const f=P;e.fillStyle=y,e.fillRect(0,t-f,t,f);let h=a;if(e.measureText(h).width>p){for(;h.length&&e.measureText(h+"…").width>p;)h=h.slice(0,-1);h+="…"}e.fillStyle=u,e.textBaseline="middle",e.fillText(h,w,t-f/2)}}z(e,o.layers);const v=i==="png"?"image/png":"image/jpeg",L=await new Promise((p,U)=>n.toBlob(f=>f?p(f):U(new Error("toBlob failed")),v,v==="image/jpeg"?m:void 0));return{bytes:new Uint8Array(await L.arrayBuffer()),mime:v,width:t,height:t}}function N(r,a="story-squares.pdf"){const o=new Blob([r],{type:"application/pdf"}),t=document.createElement("a"),s=URL.createObjectURL(o);t.href=s,t.download=a,document.body.appendChild(t),t.click(),t.remove(),URL.revokeObjectURL(s)}function J(r,a,o){const t=a.replace(/\r\n?/g,`
`).split(`
`),s=[];for(const y of t){const u=y.split(/\s+/);let i="";for(const m of u){const l=i?i+" "+m:m;if(r.measureText(l).width<=o)i=l;else if(i&&s.push(i),r.measureText(m).width>o){let n="";for(const e of m){const d=n+e;r.measureText(d).width<=o?n=d:(s.push(n),n=e)}i=n}else i=m}s.push(i)}return s}async function Y(r,a,o,t={},s){const y=t.size??F,u=t.format??"jpeg",i=t.quality??H,m=t.onProgress,l=await q.create(),n=r.length,e=performance.now(),d=c=>{if(!m)return;const g=performance.now()-e,x=Math.round(c/n*100),b=c>0?g/c*(n-c):void 0;m({done:c,total:n,elapsedMs:g,etaMs:b,pct:x})};d(0);for(let c=0;c<n;c++){const g=r[c],x=(a[g.id]??"").trim(),b=o[g.id]??I,T=s?.[g.id],{bytes:M,mime:S,width:R,height:C}=await k(g,x,{size:y,format:u,quality:i,transform:b,bg:t.bg,captionBg:t.captionBg,textColor:t.textColor,layers:T}),P=S==="image/png"?await l.embedPng(M):await l.embedJpg(M);l.addPage([R,C]).drawImage(P,{x:0,y:0,width:R,height:C}),d(c+1),await new Promise(B=>setTimeout(B,0))}const A=await l.save();N(A)}export{Y as exportCardsToPdf};
