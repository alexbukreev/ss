import{P as v}from"./pdf-lib-F-JeKLTy.js";import{C as x,P as D,D as E,e as F,d as U}from"./index-DgafE8qN.js";import"./vendor-react-CQrsTYwo.js";import"./vendor-ui-Tl69VNYc.js";async function j(){const n=document;if(n?.fonts?.ready&&typeof n.fonts.ready.then=="function")try{await n.fonts.ready}catch{}}async function C(n){return new Promise((o,t)=>{const e=new Image;e.onload=()=>o(e),e.onerror=i=>t(i),e.src=n})}async function I(n,o={}){const t=o.size??x,e=o.bg??"transparent",i=o.format??"jpeg",b=o.quality??D,l=o.transform??E,d=document.createElement("canvas");d.width=t,d.height=t;const s=d.getContext("2d");if(!s)throw new Error("No 2D context");e!=="transparent"&&(s.fillStyle=e,s.fillRect(0,0,t,t));const r=await C(n.url),m=t/r.width,P=t/r.height,h=Math.min(m,P)*l.scale,a=Math.round(r.width*h),c=Math.round(r.height*h),w=Math.round((t-a)/2+l.tx/100*t),g=Math.round((t-c)/2+l.ty/100*t);s.imageSmoothingQuality="high",s.drawImage(r,w,g,a,c),U(s,o.layers,t);const f=i==="png"?"image/png":"image/jpeg",M=await new Promise((y,u)=>d.toBlob(p=>p?y(p):u(new Error("toBlob failed")),f,f==="image/jpeg"?b:void 0));return{bytes:new Uint8Array(await M.arrayBuffer()),mime:f,width:t,height:t}}function T(n,o="story-squares.pdf"){const t=new Blob([n],{type:"application/pdf"}),e=document.createElement("a"),i=URL.createObjectURL(t);e.href=i,e.download=o,document.body.appendChild(e),e.click(),e.remove(),URL.revokeObjectURL(i)}async function O(n,o,t,e={},i){const b=e.size??x,l=e.format??"jpeg",d=e.quality??D,s=e.onProgress,r=await v.create(),m=n.length,P=performance.now(),R=a=>{if(!s)return;const c=performance.now()-P,w=Math.round(a/m*100),g=a>0?c/a*(m-a):void 0;s({done:a,total:m,elapsedMs:c,etaMs:g,pct:w})};R(0);for(let a=0;a<m;a++){const c=n[a],w=t?.[c.id]??E,g=i?.[c.id];await F(g),await j();const{bytes:f,mime:M,width:y,height:u}=await I(c,{size:b,format:l,quality:d,transform:w,bg:e.bg,layers:g}),p=M==="image/png"?await r.embedPng(f):await r.embedJpg(f);r.addPage([y,u]).drawImage(p,{x:0,y:0,width:y,height:u}),R(a+1),await new Promise(L=>setTimeout(L,0))}const h=await r.save();T(h)}export{O as exportCardsToPdf};
